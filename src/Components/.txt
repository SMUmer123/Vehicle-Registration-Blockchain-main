import React, { useEffect, useState } from "react";
import Web3 from "web3";
import { contractABI, contractAddress } from "../../config";
import { useNavigate } from "react-router-dom";
import "./GovtView.css";
import TransactionViewer from "./TransactionViewer";
// Import Firebase
import { getFirestore, doc, getDoc, updateDoc } from "firebase/firestore";
// Import VehicleDetails component
import VehicleDetails from "./../VehicleDetails";

const GovDashboard = () => {
  const [web3, setWeb3] = useState(null);
  const [contract, setContract] = useState(null);
  const [account, setAccount] = useState("");
  const [pendingUsers, setPendingUsers] = useState([]);
  const [pendingVehicles, setPendingVehicles] = useState([]);
  const [pendingTransfers, setPendingTransfers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [view, setView] = useState("users");
  const [selectedUser, setSelectedUser] = useState(null);
  const [userDetails, setUserDetails] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const [selectedTransfer, setSelectedTransfer] = useState(null);
  const [transferDetails, setTransferDetails] = useState(null);
  const [showTransferModal, setShowTransferModal] = useState(false);
  // Add new state for vehicle details
  const [selectedVehicle, setSelectedVehicle] = useState(null);
  const [showVehicleModal, setShowVehicleModal] = useState(false);

  const navigate = useNavigate();
  const db = getFirestore();

  useEffect(() => {
    const init = async () => {
      if (!window.ethereum) {
        alert("âš ï¸ MetaMask not detected");
        return navigate("/govtLogin");
      }

      try {
        const web3Instance = new Web3(window.ethereum);
        const accounts = await web3Instance.eth.requestAccounts();
        const currentAccount = accounts[0];

        const contractInstance = new web3Instance.eth.Contract(contractABI, contractAddress);
        const govtAddress = await contractInstance.methods.government().call();

        if (currentAccount.toLowerCase() !== govtAddress.toLowerCase()) {
          alert("âŒ Unauthorized. You are not the government.");
          return navigate("/govtLogin");
        }

        setWeb3(web3Instance);
        setContract(contractInstance);
        setAccount(currentAccount);

        await loadPendingData(contractInstance);
      } catch (error) {
        console.error("Initialization error:", error);
        alert("Failed to initialize: " + error.message);
      }
    };

    init();
  }, [navigate]);

  const loadPendingData = async (contractInstance) => {
    try {
      await loadPendingUsersAndVehicles(contractInstance);
      await loadPendingTransfers(contractInstance);
    } catch (error) {
      console.error("Error loading pending data:", error);
      alert("Failed to load pending data");
    } finally {
      setLoading(false);
    }
  };

  const loadPendingUsersAndVehicles = async (contractInstance) => {
    try {
      const userCount = await contractInstance.methods.userCount().call();
      const vehicleCount = await contractInstance.methods.registrationCount().call();

      const users = [];
      for (let i = 1; i <= userCount; i++) {
        const user = await contractInstance.methods.users(i).call();
        if (!user.approvedByGovt) users.push(user);
      }

      const vehicles = [];
      for (let i = 1; i <= vehicleCount; i++) {
        const vehicle = await contractInstance.methods.vehicleRegistrations(i).call();
        if (!vehicle.approved) vehicles.push(vehicle);
      }

      setPendingUsers(users);
      setPendingVehicles(vehicles);
    } catch (error) {
      console.error("Error loading pending users and vehicles:", error);
      throw error;
    }
  };

  const loadPendingTransfers = async (contractInstance) => {
    try {
      const transferCount = await contractInstance.methods.transferRequestCount().call();
      const transfers = [];
      
      for (let i = 1; i <= transferCount; i++) {
        const transfer = await contractInstance.methods.getTransferRequest(i).call();
        
        // Only show transfers that are not approved and not completed
        if (!transfer.approved && !transfer.completed) {
          // Get vehicle details
          const vehicle = await contractInstance.methods.vehicleRegistrations(transfer.registrationId).call();
          transfers.push({
            requestId: i,
            registrationId: transfer.registrationId,
            vehicleNo: vehicle.vehicleNo,
            vehicleMake: vehicle.vehicleMake,
            vehicleModel: vehicle.vehicleModel,
            vehicleYear: vehicle.vehicleModelYear,
            currentOwner: transfer.currentOwner,
            newOwner: transfer.newOwner
          });
        }
      }
      
      setPendingTransfers(transfers);
    } catch (error) {
      console.error("Error loading pending transfers:", error);
      throw error;
    }
  };

  // Function to update Firebase user approval status
  const updateUserApprovalInFirebase = async (userWallet) => {
    try {
      const userRef = doc(db, "users", userWallet);
      
      // Update the approved field to true
      await updateDoc(userRef, {
        approved: true,
        updatedAt: new Date().toISOString()
      });
      
      console.log("Firebase user approval status updated successfully");
      return true;
    } catch (error) {
      console.error("Error updating Firebase user approval:", error);
      return false;
    }
  };

  const approveUser = async (userWallet) => {
    try {
      setLoading(true);
      
      // First update the blockchain
     await contract.methods.approveUser(userWallet).send({ from: account });
     
      // Then update Firebase
      const firebaseUpdateResult = await updateUserApprovalInFirebase(userWallet);
      
      if (firebaseUpdateResult) {
        alert("âœ… User approved successfully!");
      } else {
        alert("âš ï¸ User approved in blockchain but failed to update Firebase.");
      }
      
      await loadPendingData(contract);
    } catch (err) {
      console.error("User approval error:", err);
      alert("âŒ User approval failed: " + err.message);
    } finally {
      setLoading(false);
    }
  };

  // Function to update Firebase vehicle approval status
  const updateVehicleApprovalInFirebase = async (regId) => {
    try {
      // First, get the vehicle details from the blockchain to get the vehicleNo
      const vehicle = await contract.methods.vehicleRegistrations(regId).call();
      const vehicleNo = vehicle.vehicleNo;
      
      // Now use vehicleNo as the document ID in Firebase
      const vehicleRef = doc(db, "vehicles", vehicleNo);
      
      // Update the approved field to true
      await updateDoc(vehicleRef, {
        approved: true,
        updatedAt: new Date().toISOString()
      });
      
      console.log("Firebase vehicle approval status updated successfully");
      return true;
    } catch (error) {
      console.error("Error updating Firebase vehicle approval:", error);
      return false;
    }
  };

  const approveVehicle = async (regId) => {
    try {
      setLoading(true);
      await contract.methods.approveVehicle(regId).send({ from: account });
      const firebaseUpdateResult = await updateVehicleApprovalInFirebase(regId);
    
      if (firebaseUpdateResult) {
        alert("âœ… Vehicle approved successfully!");
      } else {
        alert("âš ï¸ Vehicle approved in blockchain but failed to update Firebase.");
      }
      
      await loadPendingData(contract);
    } catch (err) {
      console.error("Vehicle approval error:", err);
      alert("âŒ Vehicle approval failed: " + err.message);
    } finally {
      setLoading(false);
    }
  };

  // Function to update Firebase transfer completion
  const updateTransferCompletionInFirebase = async (vehicleNo, newOwnerWallet) => {
    try {
      const vehicleRef = doc(db, "vehicles", vehicleNo);
      
      await updateDoc(vehicleRef, {
        ownerWallet: newOwnerWallet,
        transferStatus: "completed",
        transferCompletionDate: new Date().toISOString()
      });
      
      console.log("Transfer completion updated in Firebase");
      return true;
    } catch (error) {
      console.error("Error updating transfer completion in Firebase:", error);
      return false;
    }
  };

  // Function to approve ownership transfer
  const approveTransfer = async (requestId) => {
    try {
      setLoading(true);
      
      // Approve the transfer on blockchain
      await contract.methods.approveOwnershipTransfer(requestId).send({ from: account });
      
      // Get transfer details to update Firebase
      const transfer = await contract.methods.getTransferRequest(requestId).call();
      const vehicle = await contract.methods.vehicleRegistrations(transfer.registrationId).call();
      
      // Update Firebase
      const firebaseUpdateResult = await updateTransferCompletionInFirebase(vehicle.vehicleNo, transfer.newOwner);
      
      if (firebaseUpdateResult) {
        alert("âœ… Transfer approved and completed successfully!");
      } else {
        alert("âš ï¸ Transfer approved in blockchain but failed to update Firebase.");
      }
      
      await loadPendingData(contract);
      setShowTransferModal(false);
    } catch (error) {
      console.error("Transfer approval error:", error);
      alert("âŒ Transfer approval failed: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  // Function to fetch user details from Firebase
  const fetchUserDetails = async (wallet) => {
    try {
      setLoading(true);
      const userRef = doc(db, "users", wallet);
      const userSnap = await getDoc(userRef);
      
      if (userSnap.exists()) {
        setUserDetails(userSnap.data());
        setShowModal(true);
      } else {
        alert("User details not found in Firebase");
      }
    } catch (error) {
      console.error("Error fetching user details:", error);
      alert("Failed to fetch user details: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  // Function to fetch vehicle details from both blockchain and Firebase
  const fetchVehicleDetails = async (regId) => {
    try {
      setLoading(true);
      
      // Get vehicle details from blockchain
      const vehicle = await contract.methods.vehicleRegistrations(regId).call();
      
      // Get additional details from Firebase if needed
      const vehicleRef = doc(db, "vehicles", vehicle.vehicleNo);
      const vehicleSnap = await getDoc(vehicleRef);
      
      let vehicleDetails = {
        ...vehicle,
        // Add any Firebase specific fields if available
        ...(vehicleSnap.exists() ? vehicleSnap.data() : {})
      };
      
      // Set the vehicle details and show modal
      setSelectedVehicle(vehicleDetails);
      setShowVehicleModal(true);
    } catch (error) {
      console.error("Error fetching vehicle details:", error);
      alert("Failed to fetch vehicle details: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  // Function to fetch transfer details
  const fetchTransferDetails = async (transfer) => {
    try {
      setLoading(true);
      
      // Fetch current owner details
      const currentOwnerRef = doc(db, "users", transfer.currentOwner);
      const currentOwnerSnap = await getDoc(currentOwnerRef);
      
      // Fetch new owner details
      const newOwnerRef = doc(db, "users", transfer.newOwner);
      const newOwnerSnap = await getDoc(newOwnerRef);
      
      // Get full vehicle details from blockchain
      const vehicle = await contract.methods.vehicleRegistrations(transfer.registrationId).call();
      
      // Get additional vehicle details from Firebase if needed
      const vehicleRef = doc(db, "vehicles", transfer.vehicleNo);
      const vehicleSnap = await getDoc(vehicleRef);
      
      let transferInfo = {
        ...transfer,
        currentOwnerDetails: currentOwnerSnap.exists() ? currentOwnerSnap.data() : null,
        newOwnerDetails: newOwnerSnap.exists() ? newOwnerSnap.data() : null,
        // Include full vehicle details
        vehicleDetails: {
          ...vehicle,
          ...(vehicleSnap.exists() ? vehicleSnap.data() : {})
        }
      };
      
      setTransferDetails(transferInfo);
      setShowTransferModal(true);
    } catch (error) {
      console.error("Error fetching transfer details:", error);
      alert("Failed to fetch transfer details: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  // Function to close the modals
  const closeModal = () => {
    setShowModal(false);
    setUserDetails(null);
  };

  const closeVehicleModal = () => {
    setShowVehicleModal(false);
    setSelectedVehicle(null);
  };

  const closeTransferModal = () => {
    setShowTransferModal(false);
    setTransferDetails(null);
  };

  if (loading) return (
    <div className="loading-container">
      <p className="loading-text">ðŸ”„ Loading dashboard...</p>
    </div>
  );
  
  const handleLogout = () => {
    window.localStorage.removeItem("email");
    window.localStorage.removeItem("walletAddress");
    window.location.href = "/";
  };
  
  return (
    <div className="gov-dashboard-container">
      {/* Top Navigation Bar */}
      <div className="gov-navbar">
        <h2 className="navbar-title">ðŸš” Government Dashboard</h2>
        <div className="navbar-buttons">
          <button onClick={() => setView("users")} className={view === "users" ? "active" : ""}>Pending Users</button>
          <button onClick={() => setView("vehicles")} className={view === "vehicles" ? "active" : ""}>Pending Vehicles</button>
          <button onClick={() => setView("transfers")} className={view === "transfers" ? "active" : ""}>Pending Transfers</button>
          <button onClick={() => setView("transactions")} className={view === "transactions" ? "active" : ""}>ðŸ“Š All Transactions</button>
          
         <button onClick={handleLogout} className="logoutbutton" style={{ backgroundColor: "red", fontWeight: "bold", color: "white" }}>
            Logout
          </button>
        </div>
      </div>

      {/* Sections Based on View */}
      {view === "users" && (
        <div className="dashboard-section">
          <h3>Pending Users</h3>
          {pendingUsers.length === 0 ? (
            <p className="no-data-message">No pending users to approve</p>
          ) : (
            <ul className="dashboard-list">
              {pendingUsers.map((user, index) => (
                <li className="dashboard-item" key={index}>
                  <div className="item-details">
                    <strong>Email:</strong> {user.email} <br />
                    <strong>Wallet:</strong> {user.wallet}
                  </div>
                  <div className="action-buttons">
                    <button 
                      className="view-button"
                      onClick={() => fetchUserDetails(user.wallet)}
                    >
                      View Details
                    </button>
                    <button 
                      className="approve-button"
                      onClick={() => approveUser(user.wallet)}
                    >
                      Approve
                    </button>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>
      )}
      
      {view === "transactions" && (
        <div className="dashboard-section">
          <TransactionViewer 
            web3={web3} 
            contract={contract} 
            account={account} 
          />
        </div>
      )}
      
      {view === "vehicles" && (
        <div className="dashboard-section">
          <h3>Pending Vehicles</h3>
          {pendingVehicles.length === 0 ? (
            <p className="no-data-message">No pending vehicles to approve</p>
          ) : (
            <ul className="dashboard-list">
              {pendingVehicles.map((v, index) => (
                <li className="dashboard-item" key={index}>
                  <div className="item-details">
                    <strong>Vehicle:</strong> {v.vehicleNo} ({v.vehicleMake}) <br />
                    <strong>Owner:</strong> {v.ownerWallet}
                  </div>
                  <div className="action-buttons">
                    <button 
                      className="view-button"
                      onClick={() => fetchUserDetails(v.ownerWallet)}
                    >
                      View Owner Details
                    </button>
                    {/* Add new button for vehicle details */}
                    <button 
                      className="view-button"
                      onClick={() => fetchVehicleDetails(v.id)}
                    >
                      View Vehicle Details
                    </button>
                    <button 
                      className="approve-button"
                      onClick={() => approveVehicle(v.id)}
                    >
                      Approve
                    </button>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>
      )}

      {view === "transfers" && (
        <div className="dashboard-section">
          <h3>Pending Vehicle Transfers</h3>
          {pendingTransfers.length === 0 ? (
            <p className="no-data-message">No pending transfers to approve</p>
          ) : (
            <ul className="dashboard-list">
              {pendingTransfers.map((transfer, index) => (
                <li className="dashboard-item" key={index}>
                  <div className="item-details">
                    <strong>Vehicle:</strong> {transfer.vehicleNo} ({transfer.vehicleMake} {transfer.vehicleModel}) <br />
                    <strong>From:</strong> {transfer.currentOwner.substring(0, 10)}...{transfer.currentOwner.substring(34)} <br />
                    <strong>To:</strong> {transfer.newOwner.substring(0, 10)}...{transfer.newOwner.substring(34)}
                  </div>
                  <div className="action-buttons">
                    <button 
                      className="view-button"
                      onClick={() => fetchTransferDetails(transfer)}
                    >
                      View Details
                    </button>
                    {/* Add new button for vehicle details */}
                    <button 
                      className="view-button"
                      onClick={() => fetchVehicleDetails(transfer.registrationId)}
                    >
                      View Vehicle Details
                    </button>
                    <button 
                      className="approve-button"
                      onClick={() => approveTransfer(transfer.requestId)}
                    >
                      Approve Transfer
                    </button>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>
      )}

      {/* Modal for User Details */}
      {showModal && userDetails && (
        <div className="modal-overlay" onClick={closeModal}>
          <div className="user-details-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3>User Details</h3>
              <button className="close-button" onClick={closeModal}>Ã—</button>
            </div>
            <div className="modal-content">
              <div className="user-info-grid">
                <div className="info-item">
                  <span className="info-label">Name:</span>
                  <span className="info-value">{userDetails.name}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">Email:</span>
                  <span className="info-value">{userDetails.email}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">Wallet:</span>
                  <span className="info-value">{userDetails.wallet}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">CNIC:</span>
                  <span className="info-value">{userDetails.cnic}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">CNIC Issue Date:</span>
                  <span className="info-value">{userDetails.cnicIssuanceDate}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">CNIC Expiry Date:</span>
                  <span className="info-value">{userDetails.cnicExpiryDate}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">Date of Birth:</span>
                  <span className="info-value">{userDetails.dateOfBirth}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">Gender:</span>
                  <span className="info-value">{userDetails.gender}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">Phone Number:</span>
                  <span className="info-value">{userDetails.phoneNumber}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">Occupation:</span>
                  <span className="info-value">{userDetails.occupation}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">Address:</span>
                  <span className="info-value">{userDetails.address}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">City:</span>
                  <span className="info-value">{userDetails.city}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">Province:</span>
                  <span className="info-value">{userDetails.province}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">Postal Code:</span>
                  <span className="info-value">{userDetails.postalCode}</span>
                </div>
                <div className="info-item">
                  <span className="info-label">Account Created:</span>
                  <span className="info-value">
                    {new Date(userDetails.createdAt).toLocaleDateString()}
                  </span>
                </div>
              </div>
            </div>
            <div className="modal-footer">
              <button 
                className="approve-button modal-approve-btn"
                onClick={() => {
                  closeModal();
                  // If we're viewing a user from the pendingUsers list
                  const pendingUser = pendingUsers.find(u => u.wallet === userDetails.wallet);
                  if (pendingUser) {
                    approveUser(userDetails.wallet);
                  }
                  // If we're viewing a vehicle owner
                  const pendingVehicle = pendingVehicles.find(v => v.ownerWallet === userDetails.wallet);
                  if (pendingVehicle && view === "vehicles") {
                    approveVehicle(pendingVehicle.id);
                  }
                }}
              >
                Approve {view === "users" ? "User" : "Vehicle"}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal for Vehicle Details */}
      {showVehicleModal && selectedVehicle && (
        <div className="modal-overlay" onClick={closeVehicleModal}>
          <div className="vehicle-details-container" onClick={e => e.stopPropagation()}>
            <VehicleDetails vehicle={selectedVehicle} onClose={closeVehicleModal} />
          </div>
        </div>
      )}

      {/* Modal for Transfer Details */}
      {showTransferModal && transferDetails && (
        <div className="modal-overlay" onClick={closeTransferModal}>
          <div className="transfer-details-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3>Transfer Details</h3>
              <button className="close-button" onClick={closeTransferModal}>Ã—</button>
            </div>
            <div className="modal-content">
              <div className="transfer-details-section">
                <h4>Vehicle Information</h4>
                <div className="info-grid">
                  <div className="info-item">
                    <span className="info-label">Registration Number:</span>
                    <span className="info-value">{transferDetails.vehicleNo}</span>
                  </div>
                  <div className="info-item">
                    <span className="info-label">Make:</span>
                    <span className="info-value">{transferDetails.vehicleMake}</span>
                  </div>
                  <div className="info-item">
                    <span className="info-label">Model:</span>
                    <span className="info-value">{transferDetails.vehicleModel}</span>
                  </div>
                  <div className="info-item">
                    <span className="info-label">Year:</span>
                    <span className="info-value">{transferDetails.vehicleYear}</span>
                  </div>
                  {/* Add button to view complete vehicle details */}
                  <div className="info-item">
                    <button 
                      className="view-button full-width-btn"
                      onClick={() => fetchVehicleDetails(transferDetails.registrationId)}
                    >
                      View Complete Vehicle Details
                    </button>
                  </div>
                </div>
              </div>

              <div className="transfer-details-section">
                <h4>Current Owner</h4>
                {transferDetails.currentOwnerDetails ? (
                  <div className="info-grid">
                    <div className="info-item">
                      <span className="info-label">Name:</span>
                      <span className="info-value">{transferDetails.currentOwnerDetails.name}</span>
                    </div>
                    <div className="info-item">
                      <span className="info-label">Wallet:</span>
                      <span className="info-value">{transferDetails.currentOwner}</span>
                    </div>
                    <div className="info-item">
                      <span className="info-label">CNIC:</span>
                      <span className="info-value">{transferDetails.currentOwnerDetails.cnic}</span>
                    </div>
                    <div className="info-item">
                      <span className="info-label">Email:</span>
                      <span className="info-value">{transferDetails.currentOwnerDetails.email}</span>
                    </div>
                  </div>
                ) : (
                  <p>No detailed information available for current owner</p>
                )}
              </div>

              <div className="transfer-details-section">
                <h4>New Owner</h4>
                {transferDetails.newOwnerDetails ? (
                  <div className="info-grid">
                    <div className="info-item">
                      <span className="info-label">Name:</span>
                      <span className="info-value">{transferDetails.newOwnerDetails.name}</span>
                    </div>
                    <div className="info-item">
                      <span className="info-label">Wallet:</span>
                      <span className="info-value">{transferDetails.newOwner}</span>
                    </div>
                    <div className="info-item">
                      <span className="info-label">CNIC:</span>
                      <span className="info-value">{transferDetails.newOwnerDetails.cnic}</span>
                    </div>
                    <div className="info-item">
                      <span className="info-label">Email:</span>
                      <span className="info-value">{transferDetails.newOwnerDetails.email}</span>
                    </div>
                  </div>
                ) : (
                  <p>No detailed information available for new owner</p>
                )}
              </div>
            </div>
            <div className="modal-footer">
              <button 
                className="approve-button modal-approve-btn"
                onClick={() => approveTransfer(transferDetails.requestId)}
              >
                Approve Transfer
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default GovDashboard;